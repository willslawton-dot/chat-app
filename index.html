<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<title>Chat App</title>
<style>
/* --- STYLE.CSS EMBEDDED --- */
body { margin:0; background:#111; color:white; font-family:Arial; }
.container { width:100%; max-width:420px; margin:auto; padding:20px; }
input, button { width:100%; padding:12px; margin:6px 0; border-radius:8px; border:none; }
button { background:#4caf50; color:white; cursor:pointer; }
#chatBox { height:300px; overflow-y:auto; background:#222; padding:10px; border-radius:10px; }
.message { padding:6px; margin:4px 0; background:#333; border-radius:6px; }
.admin-panel { background:#222; padding:15px; border-radius:10px; margin-top:20px; }
</style>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
<div class="container">

<h2>Login</h2>
<input id="email" placeholder="Email" />
<input id="password" type="password" placeholder="Password" />
<button onclick="login()">Login</button>

<h2>Sign Up</h2>
<input id="su_username" placeholder="Username" />
<input id="su_email" placeholder="Email" />
<input id="su_password" type="password" placeholder="Password" />
<button onclick="signUp()">Sign Up</button>

<div id="accessCodeArea" style="display:none;">
<h2>Enter Access Code</h2>
<input id="accessCodeInput" placeholder="1234" />
<button onclick="checkAccessCode()">Enter</button>
</div>

<div id="chatArea" style="display:none;">
<h2>Chat Room</h2>
<div id="chatBox"></div>
<input id="msg" placeholder="Type message..." />
<button onclick="sendMessage()">Send</button>
</div>

<div id="adminPanel" class="admin-panel" style="display:none;">
<h3>Admin Panel</h3>
<button onclick="clearMessages()">Clear All Messages</button>
</div>

</div>

<script>
// --- SCRIPT.JS EMBEDDED ---
const SUPABASE_URL = "https://gpkvjpmdymusmhfycwoo.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imdwa3ZqcG1keW11c21oZnljd29vIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMzNTc3MzAsImV4cCI6MjA3ODkzMzczMH0.9JpvwEG86EK4XPmRuZ6zSSVh2lDGa4bQ2nnindXNnFk";
const db = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
let currentUser = null;

async function signUp(){
  let username = document.getElementById("su_username").value;
  let email = document.getElementById("su_email").value;
  let password = document.getElementById("su_password").value;
  await db.auth.signUp({ email, password, options:{ data:{ username } } });
  alert("Signed up! Now login.");
}

async function login(){
  let email = document.getElementById("email").value;
  let password = document.getElementById("password").value;
  const { data } = await db.auth.signInWithPassword({ email, password });
  if(data.user){ currentUser = data.user; checkAccess(); }
}

async function checkAccess(){
  document.getElementById("accessCodeArea").style.display = "block";
}

async function checkAccessCode(){
  let entered = document.getElementById("accessCodeInput").value;
  let { data } = await db.from('settings').select('*').single();
  if(entered === data.access_code){ loadChat(); }
  else alert("Wrong code");
}

async function loadChat(){
  document.getElementById("chatArea").style.display = "block";
  loadMessages();
  db.channel("chat-room").on("postgres_changes",{event:"INSERT",schema:"public",table:"messages"},payload=>{
    addMessage(payload.new);
  }).subscribe();

  // check admin
  let { data:profile } = await db.from('profiles').select('*').eq('id', currentUser.id).single();
  if(profile.is_admin){ document.getElementById("adminPanel").style.display = 'block'; }
}

async function sendMessage(){
  let msg = document.getElementById("msg").value;
  if(!msg) return;
  await db.from('messages').insert({ user_id: currentUser.id, content: msg });
  document.getElementById("msg").value = "";
}

async function loadMessages(){
  let { data } = await db.from('messages').select('*').order('id');
  data.forEach(m=>addMessage(m));
}

function addMessage(m){
  let box = document.getElementById("chatBox");
  let div = document.createElement("div");
  div.className = "message";
  div.textContent = m.content;
  box.appendChild(div);
  box.scrollTop = box.scrollHeight;
}

async function clearMessages(){
  await db.from('messages').delete().neq('id',0);
  document.getElementById("chatBox").innerHTML = "";
}
</script>
</body>
</html>
